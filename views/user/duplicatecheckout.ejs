<%- include('../layout/User/header') %>

<style>
   
   #place-order-btn {
    margin-top: 20px;
    background-color: #28a745;
}

#place-order-btn:hover {
    background-color: #218838;
}

.paymentdiv {
    background-color:white;
}




</style>

<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Checkout<span>Shop</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/cart">cart</a></li>
                <li class="breadcrumb-item active" aria-current="page">Checkout</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="checkout">
            <div class="container">
                <div class="checkout-discount">
                    <form action="#">
                        <input type="text" class="form-control" required id="checkout-discount-input">
                        <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to enter your code</span></label>
                    </form>
                </div>
                <form action="#">
                    <div class="row">
                        <div class="col-lg-9">
                            <h2 class="checkout-title">Select Address</h2>
                                
                            <div id="addressRadioGroup">
                                <% if (user && user.address && user.address.length> 0) { %>
                                    <% user.address.forEach(Address=> { %>
                                        <div class="form-check address-container">
                                            <input class="form-check-input" type="radio" name="selectedAddress"
                                                id="<%= `address${Address._id}` %>"
                                                value="<%= JSON.stringify(Address) %>">
                                            <label class="form-check-label"
                                                for="<%= `address${Address._Id}` %>">
                                                <%= `Name: ${Address.name}, Mobile: ${Address.mobile}, Address:
                                                    ${Address.address}, City: ${Address.city}, Pincode:
                                                    ${Address.pincode}, State: ${Address.state}` %>
                                            </label>

                                            <a href="#" data-toggle="modal"
                                            data-target="#editModal<%=Address._id%>">Edit <i
                                                class="icon-edit"></i></a>

                                                
                                                
                                        </div>
                                        <% }); %>
                                            <% } else { %>
                                                <p>No addresses found for this user.</p>
                                                <% } %>
                            </div>


                            <% user.address.forEach((Address)=>{%>
                                <div class="modal fade" id="editModal<%= Address._id %>" tabindex="-1"
                                    role="dialog" aria-labelledby="editModalLabel<%= Address._id %>"
                                    aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <!-- Add your modal content here -->
                                            <div class="modal-header">
                                                <h5 class="modal-title"
                                                    id="editModalLabel<%= Address._id %>">Edit Address
                                                </h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>

                                            <div class="modal-body">
                                                <!-- Add your form fields with predefined values here -->
                                                <form id="editForm<%= Address._id %>">
                                                    <!-- Example input field (replace with your actual form fields) -->
                                                    <div class="modal-body mx-3">
                                                        <div class="modal-body mx-3">
                                                            <div class="form-group">
                                                                <label
                                                                    for="editName<%= Address._id %>">Name</label>
                                                                <input type="text" class="form-control"
                                                                    id="editName<%= Address._id %>"
                                                                    value="<%= Address.name %>"
                                                                    name="name">

                                                                <p id="addname" style="color: red"></p>
                                                            </div>

                                                            <div class="form-group">
                                                                <label
                                                                    for="editMobile<%= Address._id %>">Mobile
                                                                    Number</label>
                                                                <input type="tel" class="form-control"
                                                                    id="editMobile<%= Address._id %>"
                                                                    value="<%= Address.mobile %>"
                                                                    name="mobile" required>
                                                                <p id="addmobile" style="color: red"></p>
                                                            </div>

                                                            <div class="form-group">
                                                                <label
                                                                    for="editPincode<%= Address._id %>">Pincode</label>
                                                                <input type="text"
                                                                    class="form-control"
                                                                    id="editPincode<%= Address._id %>"
                                                                    value="<%= Address.pincode %>"
                                                                    name="pincode" required>
                                                                <p id="addpin" style="color: red"></p>
                                                            </div>

                                                            <div class="form-group">
                                                                <label
                                                                    for="editAddress<%= Address._id %>">Address</label>
                                                                <input type="text" class="form-control"
                                                                    id="editAddress<%= Address._id %>"
                                                                    value="<%= Address.address %>"
                                                                    name="address" required>
                                                                <p id="addaddress" style="color: red"></p>
                                                            </div>

                                                            <div class="form-group">
                                                                <label
                                                                    for="editCity<%= Address._id %>">City</label>
                                                                <input type="text" class="form-control"
                                                                    id="editCity<%= Address._id %>"
                                                                    value="<%= Address.city %>"
                                                                    name="city" required>
                                                                <p id="addcity" style="color: red"></p>
                                                            </div>

                                                            <div class="form-group">
                                                                <label
                                                                    for="editState<%= Address._id %>">State</label>
                                                                <select class="form-control" id="editState<%= Address._id %>"  name="state">                                                                                                            
                                                                    <option value="<%= Address.state %>" selected> <%= Address.state %> </option>                                                                              
                                                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                                                    <option value="Karnataka">Karnataka</option>
                                                                    <option value="Goa">Goa</option>
                                                                    <option value="Mumbai">Mumbai</option>
                                                                </select>
                                                            </div>
                                                            <p id="addstate" style="color: red"></p>
                                                        </div>

                                                        <!-- Add more fields as needed -->

                                                        <!-- Example Save button -->
                                                        <button type="button" class="btn btn-primary"
                                                            onclick="saveEdit('<%= Address._id %>')">
                                                            Save Changes</button>

                                                         

                                                            
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <%})%>


                            <div id="selectedAddress"></div>
                                
                            <style>
                                .address-container {
                                    border: 2px solid #ccc;
                                    padding: 10px;
                                    margin-bottom: 10px;
                                    padding-left: 20px;
                                }
                            </style>

                           <div>
                              <!-- Add Address button with the /address route -->
                            <a href="/address" class="btn btn-primary btn-rounded mb-4 mt-3">Add Address</a>
                          </div>
                                
                                   
                          
                        </div>
                        <aside class="col-lg-3">
                            <div class="summary">
                                <h3 class="summary-title">Your Order</h3>

                                <table class="table table-summary" id="load">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>


                                    <!-- <tbody>
                                        

                                        //mj pps chythnnu dyn
                                       
                                        
                                            <tr>
                                                <td><a href="#">Product Name </a></td>
                                                <td>
                                                    
                                                </td>
                                            </tr>
                                          
                                        
                                        
                                            
                                            

                                                
                                                <tr class="summary-subtotal">
                                                    //ibde passs cartinfo  .subatoal
                                                    <td>Subtotal:</td>
                                                    <td>₹
                                                    </td>
                                                </tr>

                                                <tr>
                                                    <td>Shipping:</td>
                                                    <td>Free shipping</td>
                                                </tr>-->

                                               
                                                <!-- <tr>
                                                    <td>Discount:</td>
                                                    <td>
                                                      discount  
                                                    </td>
                                                </tr> -->
                                                   

                                                        <!-- <tr class="summary-total">
                                                            <td>Total:</td>
                                                            <td>₹
                                                            </td>
                                                        </tr>

                                    </tbody>  -->


                                    <tbody>
                                        <% if (cartData && cartData.products && cartData.products.length > 0) { %>
                                            <% cartData.products.forEach((product) => { %>
                                                <tr>
                                                    <td><a href="#">Product Name </a></td>
                                                    <td><%= product.productId.name %></td>
                                                </tr>
                                            <% }) %>
                                    
                                            <tr class="summary-subtotal">
                                                <td>Subtotal:</td>
                                                <td>₹<%= cartData.subtotal%></td>
                                            </tr>
                                    
                                            <!-- <tr>
                                                <td>Shipping:</td>
                                                <td>Free shipping</td>
                                            </tr> -->
                                    
                                  
                                            
                                            <tr>
                                                <td>CouponDiscount:</td>
                                                <td><span id="discount-amount">- 0</span></td>>
                                            </tr>

                                            <div id="collapseCoupons" class="collapse" aria-labelledby="headingCoupons" data-parent="#accordionExample">
                                                <div class="card-body">
                                                    <%
                                                        let availableCoupons = coupons.filter(function(coupon) {
                                                            return totalPrice >= coupon.minPrice;
                                                        });
                                                    %>
                                        
                                                    <% if (availableCoupons.length === 0) { %>
                                                        <p>No coupons available</p> 
                                                    <% } else { %>
                                                        <% availableCoupons.forEach(function(coupon) { %> 
                                                            <!-- Coupon List -->
                                                            <div class="coupon-list">
                                                                <div class="form-check mb-2">
                                                                    <span><%= coupon.couponCode %> - <%= coupon.percentage %>% off (Min Price: ₹<%= coupon.minPrice %> | Max Redeem Amount: ₹<%= coupon.maxRedeemAmount %>)</span> <br>
                                                                    <span>Expires on: <%= coupon.expiryDate.toDateString() %></span>
                                                                    <button
                                                                        class="btn btn-sm ml-2"
                                                                        data-coupon-id="<%= coupon._id %>"
                                                                        data-coupon-code="<%= coupon.couponCode %>"
                                                                        onclick="applyCoupon('<%= coupon._id %>', '<%= coupon.couponCode %>')"
                                                                        style="
                                                                            background: linear-gradient(45deg, #FFBA00, #FF6C00);
                                                                            color: white;
                                                                            border: none;
                                                                            border-radius: 4px;
                                                                            padding: 8px 16px;
                                                                            transition: background 0.3s ease;
                                                                        "
                                                                        onmouseover="this.style.background = 'linear-gradient(45deg, #FF6C00, #FFBA00)'"
                                                                        onmouseout="this.style.background = 'linear-gradient(45deg, #FFBA00, #FF6C00)'"
                                                                    >
                                                                        Apply
                                                                    </button>
                                                                </div>
                                                            </div><br>
                                                        <% }) %>
                                                    <% } %>
                                                </div>
                                            </div>
                                            

                                            <tr class="summary-total">
                                                <td>Total:</td>
                                                <td>₹<%= cartData.subtotal  %></td>
                                            </tr>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="2">Your cart is empty</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>




                                <!-- <div class="accordion-summary" id="accordion-payment">
                                                               
                                    <select name="paymentMethod" id="payment">
                                        <option value="Cash on delivery">Cash on delivery</option>
                                        <option value="Razorpay">Razorpay</option>
                                        <option value="wallet">Wallet</option>
                                    </select>
                                </div>

                                <button class="btn btn-outline-primary-2 btn-sorder btn-block place-order-btn" 
                                    onclick="sendSelection()">
                                    Place Order
                                </button> -->

                                <form action="/placeorder" method="post">
                                    
                                    <input type="hidden" name="couponId" id="coupon-id">
                                    <input type="hidden" name="razorpayPaymentId" id="razorpay-payment-id">
                                    <input type="hidden" name="razorpayOrderId" id="razorpay-order-id">
                                    <input type="hidden" name="razorpaySignature" id="razorpay-signature">
                                 
                                    <div class="payment_item paymentdiv">
                                        <div class="radion_btn">
                                            <input type="radio" id="f-option6" name="paymentMethod" value="razorpay" >
                                            <label for="f-option6">razorpay</label>
                                            <img height="50px" width="50px" src="/userAssets/assets/images/razorpay.png" alt="">
                                            <div class="check"></div>
                                        </div> 
                                        <p>Pay via Razorpay using a credit card, debit card, UPI, etc.</p>
                                    </div> <br> 
                                    
                                    <div class="payment_item active paymentdiv">
                                        <div class="radion_btn">
                                            <input type="radio" id="f-option7" name="paymentMethod" value="cash-on-delivery">
                                            <label for="f-option7">Cash on Delivery</label>
                                            <div class="check"></div>
                                        </div>
                                        <p>Pay with cash upon delivery.</p>
                                    </div> <br>

                                    <div class="payment_item paymentdiv">
                                        <div class="radion_btn">
                                            <input type="radio" id="f-option8" name="paymentMethod" value="wallet">
                                            <label for="f-option8">Wallet</label>
                                            <div class="check"></div>
                                        </div>
                                        <p>Pay using your wallet balance.</p>
                                    </div>  <br>

                                    <div class="creat_account">
                                        <input type="checkbox" id="f-option4" name="terms">
                                        <label for="f-option4">I've read and accept the </label>
                                        <a href="#">terms & conditions*</a>
                                    </div>
                                    <button type="submit" class="primary-btn" id="place-order-btn"  onclick="submitOrder()">Place Order</button>
                                </form>

                       

                           

                               
                            </div>
                        </aside>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>













 




 <script>
    function saveEdit(addressId) {
        Swal.fire({
            title: 'Are you sure?',
            text: 'You are about to update the address.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, update it!',
        }).then((result) => {
            if (result.isConfirmed) {

                const name = document.getElementById(`editName${addressId}`).value.trim();
                const mobile = document.getElementById(`editMobile${addressId}`).value.trim();
                const pincode = document.getElementById(`editPincode${addressId}`).value.trim();
                const address = document.getElementById(`editAddress${addressId}`).value.trim();
                const city = document.getElementById(`editCity${addressId}`).value.trim();
                const state = document.getElementById(`editState${addressId}`).value.trim();


                if (!name) {
                    const message = document.getElementById("addname").innerHTML = "Please enter name"
                    return
                }

                if (!mobile) {
                    const message = document.getElementById("addmobile").innerHTML = "Please enter mobile"
                    return
                }

                if (!pincode) {
                    const message = document.getElementById("addpin").innerHTML = "Please enter pincode"
                    return
                }

                if (!address) {
                    const message = document.getElementById("addaddress").innerHTML = "Please enter address"
                    return
                }

                if (!city) {
                    const message = document.getElementById("addcity").innerHTML = "Please enter city"
                    return
                }

                if (!state) {
                    const message = document.getElementById("addstate").innerHTML = "Please enter state"
                    return
                }





                fetch(`/updateaddress/${addressId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        mobile,
                        pincode,
                        address,
                        city,
                        state,
                    }),
                })
                    .then(response => {
                        console.log('result:',response)
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {


                        console.log('Response from the backend:', data);
                        // $('#tabaddress').load('/profile #tabaddress')

                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: data.message ||'Address updated successfully.',
                        });

                        window.location.reload();



                        // $(`#editModal${addressId}`).modal('hide');



                    })
                    .catch(error => {


                        console.error('There was a problem:', error.message);


                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to update address. Please try again.',
                        });
                    });
            }
        });
    }
</script> 

<script>
    function editprofile(){
        const name = document.getElementById('editName').value.trim();
        const mobile = document.getElementById('editMobile').value.trim();

        if (name === '' || mobile === '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Please fill in all required fields.',
                    });
                    return; 
                }

                if(!/^\d{10}$/.test(mobile)){
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Input',
                        text: 'Please enter a valid 10-digit mobile number.'
                    });
                    return;
                  }

                  const formData = {
                    name:name,
                    mobile:mobile
                  };

             // Send the data to the server using fetch API
        fetch('/edit-profile',{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response=> response.json())
        .then(data => {
            if(data.success){
                Swal.fire({
                    icon: 'success',
                title: 'Success!',
                text: 'Profile updated successfully!'  
                }).then((result)=>{
                    if(result.isConfirmed){
                     
                    window.location.href = '/profile';
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                title: 'Update Failed',
                text: 'Failed to update profile. Please try again.' 
                });
            }
        })
        .catch(error=>{
            console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'An error occurred. Please try again later.'
        });
     });
    }

</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>




<%- include('../layout/User/footer') %>